#!/bin/sh

pull-docker-images() {
    while read -r line; do
        docker pull $line
    done <$HOME/.docker_pulls

    docker container prune -f
    docker image prune -f
}

fork-sync() {
    while read -r line; do
        repos=($line)
        upstream_repo=${repos[0]}
        name=$(echo $upstream_repo | pcregrep -o2 "^(.*)\/(.*)")
        fork_repo="$GITHUB_USERNAME/$name"
        length="${#repos[@]}"
        
        if [ $length -gt 1 ]; then
            fork_repo=${repos[1]}
        fi

        directory="$GITHUB_PATH/$fork_repo"

        if [ ! -d "$directory" ]; then
            cd "$GITHUB_PATH/$GITHUB_USERNAME"
            echo "Cloning repo $fork_repo..."
            git clone git@github.com:$fork_repo.git
        fi

        cd "$directory"
        
        if [ ! $(git config remote.upstream.url) ]; then
            git remote add upstream git@github.com:$upstream_repo.git
        fi

        curr_branch=$(git rev-parse --abbrev-ref HEAD)

        if [ $curr_branch = "master" ] || [ $curr_branch = "trunk" ] ; then
            echo "Syncing fork in $fork_repo..."
            git pull upstream $curr_branch
            changed=$(git log origin/${curr_branch}..${curr_branch})

            if [ -n "${changed}" ]; then
                echo "Pushing changes to origin..."
                git push origin $curr_branch
            else
                echo "No changes"
            fi
            unset changed
        else
            echo "Working in branch $curr_branch.  Not Syncing"
        fi
        unset curr_branch
        unset repos
        unset upstream_repo
        unset fork_repo
        unset directory
        cd - 
    done <$HOME/.github_forks
}
