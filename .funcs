#!/bin/sh

fork-sync() {
    while read -r line; do
        echo $line
        repo=$(echo $line | pcregrep -o2 "^(.*)\/(.*)")
        directory="$GITHUB_PATH/$repo"

        if [ ! -d "$directory" ]; then
            cd $GITHUB_PATH
            echo "Cloning repo $GITHUB_USERNAME/$repo..."
            git clone git@github.com:$GITHUB_USERNAME/$repo.git
        fi

        cd "$directory"
        
        if [ ! $(git config remote.upstream.url) ]; then
            git remote add upstream git@github.com:$line.git
        fi

        curr_branch=$(git rev-parse --abbrev-ref HEAD)

        if [ $curr_branch = "master" ] || [ $curr_branch = "trunk" ] ; then
            echo "Syncing fork in $repo..."
            git pull upstream $curr_branch
            changed=$(git log origin/${curr_branch}..${curr_branch})

            if [ -n "${changed}" ]; then
                echo "Pushing changes to origin..."
                git push origin $curr_branch
            else
                echo "No changes"
            fi
            unset changed
        else
            echo "Working in branch $curr_branch.  Not Syncing"
        fi
        unset curr_branch
        unset repo
        unset directory
        cd -
    done <$HOME/.github_forks
}
