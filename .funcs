#!/bin/sh

pull-docker-images() {
    while read -r line; do
        docker image pull "$line"
    done <"$HOME/.docker_pulls"

    docker system prune -f
    docker volume prune -f
}

fork-sync() {
    while read -r line; do
        repos=($line)
        upstream_repo=${repos[0]}
        name=$(echo "${upstream_repo}" | pcregrep -o2 "^(.*)\/(.*)")
        fork_repo="${GITHUB_USERNAME}/${name}"
        length="${#repos[@]}"
        
        if [ $length -gt 1 ]; then
            fork_repo=${repos[1]}
        fi

        directory="${GITHUB_PATH}/${fork_repo}"

        if [ ! -d "$directory" ]; then
            (
            cd "${GITHUB_PATH}/${GITHUB_USERNAME}"
            echo "Cloning repo ${fork_repo}..."
            git clone "${fork_repo}"
            )
        fi
        (
        cd "${directory}"
        
        if [ ! $(git config remote.upstream.url) ]; then
            git remote add upstream "${upstream_repo}"
        fi

        curr_branch=$(git rev-parse --abbrev-ref HEAD)
        echo "Syncing ${curr_branch} in ${fork_repo}..."
        git sync
        
        changed=$(git log origin/${curr_branch}..${curr_branch})

        if [ -n "${changed}" ]; then
            echo "Pushing changes to origin..."
            git push
        else
            echo "No changes"
        fi

        unset changed
        unset curr_branch
        unset repos
        unset upstream_repo
        unset fork_repo
        unset directory
        ) 
    done <"${HOME}/.github_forks"
}

build-dockerfiles() {
    (
    cd "${GITHUB_PATH}/${GITHUB_USERNAME}/docker-debian"
    time docker image build --no-cache -t "${GITHUB_USERNAME}/debian:sid-slim" -t "quay.io/${GITHUB_USERNAME}/debian:sid-slim" sid-slim

    cd "${GITHUB_PATH}/${GITHUB_USERNAME}/dockerfiles"
    time docker image build --no-cache -t "${GITHUB_USERNAME}/firefox:nightly" -t "quay.io/${GITHUB_USERNAME}/firefox:nightly" firefox/nightly
    time docker image build --no-cache -t "${GITHUB_USERNAME}/youtube-dl" -t "quay.io/${GITHUB_USERNAME}/youtube-dl" youtube-dl
    time docker image build --no-cache -t "${GITHUB_USERNAME}/whois" -t "quay.io/${GITHUB_USERNAME}/whois" whois
    time docker image build --no-cache -t "${GITHUB_USERNAME}/nmap:alpine" -t "quay.io/${GITHUB_USERNAME}/nmap:alpine" nmap/alpine
    time docker image build --no-cache -t "${GITHUB_USERNAME}/subfinder" -t "quay.io/${GITHUB_USERNAME}/subfinder" subfinder
    time docker image build --no-cache -t "${GITHUB_USERNAME}/gobuster" -t "quay.io/${GITHUB_USERNAME}/gobuster" gobuster
    time docker image build --no-cache -t "${GITHUB_USERNAME}/amass" -t "quay.io/${GITHUB_USERNAME}/amass" amass
    time docker image build --no-cache -t "${GITHUB_USERNAME}/vscode:insiders" -t "quay.io/${GITHUB_USERNAME}/vscode:insiders" vscode/insiders
    time docker image build --no-cache -t "${GITHUB_USERNAME}/mitmproxy:alpine" -t "quay.io/${GITHUB_USERNAME}/mitmproxy:alpine" mitmproxy/alpine
    time docker image build --no-cache -t "${GITHUB_USERNAME}/vlc:alpine" -t "quay.io/${GITHUB_USERNAME}/vlc:alpine" vlc/alpine
    time docker image build --no-cache -t "${GITHUB_USERNAME}/tor-browser:alpha" -t "quay.io/${GITHUB_USERNAME}/tor-browser:alpha" tor-browser/alpha
    time docker image build --no-cache -t "${GITHUB_USERNAME}/slack" -t "quay.io/${GITHUB_USERNAME}/slack" slack
    time docker image build --no-cache -t "${GITHUB_USERNAME}/pv" -t "quay.io/${GITHUB_USERNAME}/pv" pv
    time docker image build --no-cache -t "${GITHUB_USERNAME}/jq" -t "quay.io/${GITHUB_USERNAME}/jq" jq/alpine
    time docker image build --no-cache -t "${GITHUB_USERNAME}/figlet" -t "quay.io/${GITHUB_USERNAME}/figlet" figlet
    )
}

push-dockerfiles() {
	docker image push "${GITHUB_USERNAME}/debian:sid-slim"
    docker image push "${GITHUB_USERNAME}/firefox:nightly"
    docker image push "${GITHUB_USERNAME}/youtube-dl"
    docker image push "${GITHUB_USERNAME}/whois"
    docker image push "${GITHUB_USERNAME}/nmap:alpine"
    docker image push "${GITHUB_USERNAME}/subfinder"
    docker image push "${GITHUB_USERNAME}/gobuster"
    docker image push "${GITHUB_USERNAME}/amass"
    docker image push "${GITHUB_USERNAME}/vscode:insiders"
    docker image push "${GITHUB_USERNAME}/mitmproxy:alpine"
    docker image push "${GITHUB_USERNAME}/vlc:alpine"
    docker image push "${GITHUB_USERNAME}/tor-browser:alpha"
    docker image push "${GITHUB_USERNAME}/slack"
    docker image push "${GITHUB_USERNAME}/pv"
    docker image push "${GITHUB_USERNAME}/jq"
    docker image push "${GITHUB_USERNAME}/figlet"

	docker image push "quay.io/${GITHUB_USERNAME}/debian:sid-slim"
    docker image push "quay.io/${GITHUB_USERNAME}/firefox:nightly"
    docker image push "quay.io/${GITHUB_USERNAME}/youtube-dl"
    docker image push "quay.io/${GITHUB_USERNAME}/whois"
    docker image push "quay.io/${GITHUB_USERNAME}/nmap:alpine"
    docker image push "quay.io/${GITHUB_USERNAME}/subfinder"
    docker image push "quay.io/${GITHUB_USERNAME}/gobuster"
    docker image push "quay.io/${GITHUB_USERNAME}/amass" 
    docker image push "quay.io/${GITHUB_USERNAME}/vscode:insiders"
    docker image push "quay.io/${GITHUB_USERNAME}/mitmproxy:alpine"
    docker image push "quay.io/${GITHUB_USERNAME}/vlc:alpine"
    docker image push "quay.io/${GITHUB_USERNAME}/tor-browser:alpha"
    docker image push "quay.io/${GITHUB_USERNAME}/slack"
    docker image push "quay.io/${GITHUB_USERNAME}/pv"
    docker image push "quay.io/${GITHUB_USERNAME}/jq"
    docker image push "quay.io/${GITHUB_USERNAME}/figlet"

    docker system prune -f
    docker volume prune -f
}

